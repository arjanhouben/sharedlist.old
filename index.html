<html>
	<head>
		<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=yes">
		<link rel="apple-touch-icon" href="icon.png">
		<link rel="apple-touch-icon-precomposed" href="icon-precomposed.png">
		<style>
		html, body
		{
			background-color: #789;
			overflow: hidden;
			height: 100%;
			width: 100%;
			display: table;
			margin: 0;
			border-spacing: 7px;
		}
		.customfont
		{
			font-size: 18pt;
			font-family: sans-serif;
		}
		input[type=text]
		{
			background-color: transparent;
			border-color: black;
			border-width: 0 0 1px 0;
		}
		.strike > span
		{
			text-decoration: line-through;
		}
		.noselect
		{
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		.hidden
		{
			display: none;
		}
		ul
		{
			display: table-row;
			margin: 0;
			padding: 0;
			list-style-type: none;
			white-space: nowrap;
		}
		#scrollbox
		{
			height: 100%;
			overflow: auto;
		}
		#items
		{
			height: 100%;
		}
		li
		{
			padding: 3pt;
		}
		li > *
		{
			display: inline-block;
		}
		li > *:first-child
		{
			width: 70%;
			margin-right: 5%;
		}
		li > *:last-child
		{
			width: 25%;
		}
		.item
		{
		}
		.unsaved
		{
			font-style: italic;
		}
		</style>
		<script type="text/javascript" src="jquery-1.9.1.min.js"></script>
		<script type="text/javascript">
		$().ready(
			function()
			{
				var lastSynced = new Date();
				var currentData = {};
				var session = null;
				var container = $( "#scrollbox" );
				var emptyrow = $( "<li><span class=\"item noselect\"></span><input disabled=\"true\" class=\"remove\" type=\"button\" value=\"weghalen\" /></li>" );
				
				function getRow( item )
				{
					return item.parents( "li" );
				}
				
				function findItem( str )
				{
					var result = null;
					container.find( ".item" ).each(
						function( i, t )
						{
							if ( $(t).text() == str )
							{
								result = t;
								return false;
							}
						}
					);
					return $(result);
				}
				
				function updatePageJson( data )
				{
					return updatePage( JSON.parse( data ) );
				}
				
				function sortItems( a, b )
				{
					var at = $(a).find( "span" ).text();
					var bt = $(b).find( "span" ).text();
					if ( at < bt ) return -1;
					if ( at > bt ) return 1;
					return 0;
				}
				
				function sortList()
				{
					var items = container.find( "li" );
					var active = items.not( ".hidden" );
					var strike = active.filter( ".strike" );
					var normal = active.not( ".strike" );
					normal.sort( sortItems );
					strike.sort( sortItems );
					container.append( normal );
					container.append( strike );
				}
				
				function isEmpty( obj )
				{
					for(var prop in obj)
					{
						if( obj.hasOwnProperty( prop ) )
						{
							return false;
						}
					}
					return true;
				}
				
				function updatePage( data )
				{
					if ( data.session )
					{
						session = data.session;
					}
					
					if ( !isEmpty( data.errors ) )
					{
						console.log( data.errors );
					}
					
					currentData = data;
					
					var items = container.find( "li" ).remove();
					
					for ( var name in data[ "items" ] )
					{
						addRow( name );
						var i = findItem( name );
						var item = data[ "items" ][ name ];
						i.data( "modified", item[ "modified" ] );
						var row = getRow( i );
						row.removeClass( "strike" );
						row.addClass( item[ "state" ] );
						row.find( ".remove" ).attr( "disabled", !row.hasClass( "strike" ) );
					}
					
					sortList()
					
					$(".unsaved").removeClass( "unsaved" );
				}
				
				function getData()
				{
					var data = {
						"items": {}
					};
					container.find( ".item" ).each(
						function( i, t )
						{
							var str = $(t).text();
							if ( !str.length )
							{
								return;
							}
							var row = getRow( $(t) );
							data[ "items" ][ str ] = {
								"modified": $(t).data( "modified" ) || 0,
								"state": row.hasClass( "hidden" ) ? "hidden" : ( row.hasClass( "strike" ) ? "strike" : "active" )
							};
						}
					);
					return data;
				}
				
				function itemDifferent( a, b )
				{
					if ( a[ "modified" ] === b[ "modified" ] )
					{
						if ( a[ "state" ] === b[ "state" ] )
						{
							return null;
						}
					}
					return b;
				}
			
				function diff( a, b )
				{
					var result = {};
					for ( var k in b )
					{
						if ( a.hasOwnProperty( k ) )
						{
							var d = itemDifferent( a[ k ], b[ k ] )
							if ( d )
							{
								result[ k ] = d;
							}
						}
						else
						{
							result[ k ] = b[ k ];
						}
					}
					return result;
				}

				function sync()
				{
					sortList();
					
					var data = getData();
					
					data[ "items" ] = diff( currentData[ "items" ], data[ "items" ] );
					
					if ( navigator.onLine )
					{
						if ( this.last )
						{
							this.last.abort();
						}

						if ( session )
						{
							data[ "session" ] = session;
						}

						this.last = $.post(
							"sync.php",
							data,
							function( d )
							{
								updatePageJson( d );
								lastSynced = new Date();
							}
						);
					}
				}
				
				function addRow( str )
				{
					if ( !str.length )
					{
						return;
					}
					var item = findItem( str );
					var row = getRow( item );
					if ( !item.length )
					{
						row = emptyrow.clone();
						row.find( ".item" ).text( str );
						container.append( row );
					}
					else if ( row.hasClass( "hidden" ) )
					{
						row.removeClass( "hidden" );
						row.removeClass( "strike" );
						row.find( ".remove" ).attr( "disabled", true );
					}
					else if ( row.hasClass( "strike" ) )
					{
						row.removeClass( "strike" );
						row.find( ".remove" ).attr( "disabled", true );
					}
					container.find( "li:first" ).before( row );
				}
				
				function removeItem( str )
				{
					var row = getRow( findItem( str ) );
					if ( !row.length || row.hasClass( "hidden" ) )
					{
						return;
					}
					row.addClass( "hidden" );
				}
				
				var input = $("input[name=item]");
				
				$("#additem").on
				(
					"click",
					function( e )
					{
						addRow( input.val().trim() );
						sync();
						input.val( "" );
						e.preventDefault();
						input.focus();
					}
				);
				
				function syncIfNeeded()
				{
					// wait a bit in case the press that caused this update also
					// triggered a real sync
					clearTimeout( syncIfNeeded.timer );
					syncIfNeeded.timer = setTimeout(
						function()
						{
							var now = new Date();
							if ( now.getTime() - lastSynced.getTime() > 5000 )
							{
								sync();
							}
						},
						100
					)
				}
				
				var preventToggle = false;
				
				function toggleRow( e )
				{
					if ( preventToggle ) return;
					var row = getRow( $(e.target) );
					row.toggleClass( "strike" ).addClass( "unsaved" );
					var isStrike = row.hasClass( "strike" );
					row.find( ".remove" ).attr( "disabled", !isStrike );
					sync();
					e.preventDefault();
				}
				
				var refocus = false;
				
				$(this)
				.on
				(
					"click",
					".remove",
					function( e )
					{
						var str = getRow( $(this) ).find( ".item" ).text();
						removeItem( str );
						sync();
					}
				).on
				(
					"touchend",
					".item",
					function( e )
					{
						if ( refocus )
						{
							input.focus();
						}
						toggleRow( e );
					}
					
				).on
				(
					"touchmove",
					function()
					{
						preventToggle = true;
					}
				).on
				(
					"touchstart",
					function()
					{
						refocus = document.activeElement == input[ 0 ];
						input.blur();
						preventToggle = false;
						syncIfNeeded();
					}
				).on
				(
					"mouseup",
					".item",
					toggleRow
				).on(
					"keydown",
					syncIfNeeded
				).on(
					"mousedown",
					syncIfNeeded
				).on
				(
					"keyup",
					function( e )
					{
						if ( e.keyCode == 13 )
						{
							addRow( input.val().trim() );
							sync();
							input.val( "" );
						}
					}
				);
				
				function findMatching( str )
				{
					var result = [];
					for ( var i in getData().items )
					{
						if ( i.length > str.length && i.lastIndexOf( str, str.length ) === 0 )
						{
							result.push( i );
						}
					}
					return result;
				}
				
				function byLength( a, b )
				{
					return a.length > b.length;
				}
				
				function sameSize( len )
				{
					return function( a ) { return a.length === len; };
				}
				
				function suggest( str )
				{
					var i = input[ 0 ];
					var start = i.value.length;
					i.value = str;
					i.setSelectionRange( start, str.length );
					i.focus();
				}
				
				var nosuggest = false;
				
				input.on(
					"keydown",
					function( e )
					{
						switch ( e.keyCode )
						{
							case 8: // backspace
							case 46: // delete
								nosuggest = true;
								break;
							default:
								nosuggest = false;
						}
					}
				)
				
				input.on
				(
					"input",
					function( e )
					{
						this.value = this.value.toLowerCase();
						if ( nosuggest ) return;
						var str = this.value;
						if ( !str.length ) return;
						var matches = findMatching( str ).sort( byLength );
						if ( !matches.length ) return;
						matches = matches.filter( sameSize( matches[ 0 ].length ) );
						if ( matches.length === 1 )
						{
							suggest( matches[ 0 ] );
						}
					}
				).on
				(
					"touchstart",
					function( e )
					{
						if ( document.activeElement == this )
						{
							this.blur();
							e.preventDefault();
						}
					}
				);
				
				$(document).on(
					"visibilitychange",
					syncIfNeeded
				)
				
				sync();
			}
		);
		</script>
	</head>
	<body>
		<ul class="customfont">
			<li><input name="item" class="customfont" type="text" /><input id="additem" type="button" value="toevoegen" /></li>
		</ul>
		<ul class="customfont" id="items">
			<div id="scrollbox">
			</div>
		</ul>
	</body>
</html>
