<html manifest="cache.manifest">
<!--<html>-->
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no" />
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<link rel="apple-touch-icon" href="icon.png">
		<link rel="apple-touch-icon-precomposed" href="icon.png">
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
		<style>
		html, body
		{
			background-color: #789;
			overflow: hidden;
			height: 100%;
			width: 100%;
			margin: 0;
			border: 5px #789 solid;
			position: absolute;
			box-sizing: border-box;
		}
		html, body > *
		{
			position: absolute;
		}
		#items
		{
			top: 28pt;
			bottom: 0;
			left: 0;
			right: 0;
		}
		.customfont
		{
			font-size: 18pt;
			font-family: sans-serif;
			font-weight: lighter;
		}
		input[type=text]
		{
			background-color: transparent;
			border-color: black;
			border-width: 0 0 1px 0;
			border-radius: 0;
			top: 0;
			left: 0;
			right: 0;
			height: 24pt;
		}
		.strike > span
		{
			text-decoration: line-through;
			color: #555;
			width: 65%;
			overflow: hidden;
		}
		.noselect
		{
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		.hidden
		{
			display: none;
		}
		#scrollbox
		{
			height: 100%;
			overflow: auto;
		}
		.item
		{
			position: relative;
			width: 100%;
			overflow: hidden;
			white-space: nowrap;
		}
		.item > span
		{
			display: inline-block;
		}
		.item > .remove
		{
			display: none;
		}
		.item.strike > .remove
		{
			position: absolute;
			width: 30%;
			right: 0;
			display: inline-block;
		}
		.unsaved
		{
			font-style: italic;
		}
		</style>
		<script type="text/javascript">
		"use strict";
		function for_key_value( obj, f )
		{
			for ( var k in obj )
			{
				if ( obj.hasOwnProperty( k ) )
				{
					f( k, obj[ k ] );
				}
			}
		}
		function getLastModified( items )
		{
			var m = 0;
			for_key_value( items,
				function( k, v )
				{
					if ( v.modified > m )
					{
						m = v.modified;
					}
				}
			);
			return m;
		}
		function LocalData()
		{
			this.get = function()
			{
				if ( !localStorage[ "boodschappen" ] )
				{
					localStorage[ "boodschappen" ] = "{}";
				}
				return JSON.parse( localStorage[ "boodschappen" ] );
			}
			
			this.set = function( data )
			{
				localStorage[ "boodschappen" ] = JSON.stringify( data );
			}
		}
		function parseQuery( query )
		{
			var result = {};
			query
				.substr( query.indexOf( '?' ) + 1 )
				.split( '&' )
				.forEach(
					( i ) =>
					{
						var kv = i.split( '=' );
						result[ kv[ 0 ] ] = kv[ 1 ];
					}
				)
			return result;
		}
		function ALL( args, obj )
		{
			if ( !obj ) obj = document;
			return Array.prototype.slice.call( obj.querySelectorAll.call( obj, args ) );
		}
		function ONE( args, obj )
		{
			if ( !obj ) obj = document;
			return obj.querySelector.apply( obj, [ args ] );
		}
		function emptyrow()
		{
			var div = document.createElement( "div" );
			div.classList.add( "item" );
			var span = document.createElement( "span" );
			div.appendChild( span );
			div.span = span;
			var input = document.createElement( "input" );
			input.className = "remove hidden";
			input.type = "button";
			input.value = "weghalen";
			div.appendChild( input );
			div.input = input;
			return div;
		}
		function on( obj, ev, selector, f )
		{
			if( obj[ ev ] ) throw "can only assign once!";
			obj[ ev ] = function( e )
			{
				var t = e.target;
				while ( !t.matches( selector ) )
				{
					t = t.parentNode;
					if ( t == document ) return;
				}
				f.call( t, e );
			}
		}
		window.onload = function()
		{
			const query = parseQuery( location.search );
			var lastSynced = new Date();
			var currentData = new LocalData();
			var container = ONE( "#scrollbox" );
			var item_cache = {};
			
			if ( query.hasOwnProperty( "reset" ) )
			{
				currentData.set( {} );
			}
			
			function getRow( item )
			{
				while ( !item.classList.contains( "item" ) )
				{
					item = item.parentNode;
				}
				return item;
			}
			
			function findItem( str )
			{
				if ( item_cache[ str ] ) item_cache[ str ];
				ALL( "div.item:not(.hidden)>span", container ).forEach(
					function( i )
					{
						if ( i.innerText === str )
						{
							item_cache[ str ] = i.parentNode;
							return false;
						}
					}
				);
				return item_cache[ str ];
			}
			
			function get_or_create_item( str )
			{
				if ( item_cache[ str ] ) item_cache[ str ];
				var row = findItem( str );
				if ( !row )
				{
					row = emptyrow();
					function remove()
					{
						this.parentNode.classList.add( "hidden" );
						sync();
					}
					row.input.onmouseup = remove;
					row.input.ontouchend = remove;
					row.input.ontouchstart = remove;
					row.span.innerText = str;
				}
				container.appendChild( row );
				item_cache[ str ] = row;
				return row;
			}
			
			function updatePageJson( data )
			{
				return updatePage( JSON.parse( data ) );
			}
			
			function sortItems( a, b )
			{
				var as = a.classList.contains( "strike" );
				var bs = b.classList.contains( "strike" );
				if ( as )
				{
					if ( !bs )
					{
						return 1;
					}
				}
				else if ( bs )
				{
					if ( !as )
					{
						return -1;
					}
				}
				if ( a.innerText < b.innerText ) return -1;
				if ( a.innerText > b.innerText ) return 1;
				return 0;
			}
			
			function sortList()
			{
				var tmp = ALL( "div.item:not(.hidden)", container );
				tmp.sort( sortItems ).forEach(
					( v ) => { container.appendChild( v ); }
				);
			}
			
			function isEmpty( obj )
			{
				return Object.keys( obj ).length === 0;
			}
			
			function fillPage( data )
			{
				for ( var name in data )
				{
					var i = get_or_create_item( name );
					i.classList.remove( "hidden", "strike" );
					data[ name ][ "state" ].split( ' ' ).filter(Boolean).forEach( ( v ) => { i.classList.add( v ); } );
				}
				
				sortList();
			}
			
			function updatePage( data )
			{
				var complete = currentData.get();
				var diff = get_new_changes( complete, data[ "items" ] );

				for_key_value(
					data[ "items" ],
					( k, v ) => { complete[ k ] = v; }
				);

				currentData.set( complete );
									
				if ( !isEmpty( data.errors ) )
				{
					console.log( data.errors );
				}
				fillPage( diff );

				
				ALL(".unsaved").forEach( (o) => { o.classList.remove( "unsaved" ); } );
			}
			
			function getItemsFromPage()
			{
				var cache = currentData.get();
				var items = {};
				for_key_value( item_cache,
					( k, v ) => {
						items[ k ] = {
							"modified": cache[ k ][ "modified" ] || 0,
							"state": v.className.replace( / *item */, "" )
						}
					}
				)
				return items;
			}
			
			function itemDifferent( a, b )
			{
				return ( a[ "state" ] !== b[ "state" ] );
			}
		
			function get_new_changes( old_value, new_value )
			{
				var result = {};
				if ( !old_value )
				{
					return new_value;
				}
				for_key_value( new_value,
					function( k, v )
					{
						if ( old_value.hasOwnProperty( k ) )
						{
							if ( itemDifferent( old_value[ k ], v ) )
							{
								result[ k ] = v;
							}
						}
						else
						{
							result[ k ] = v;
						}
					}
				)
				return result;
			}
			
			function post( url, data, complete )
			{
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function()
				{
					if ( xhr.readyState == XMLHttpRequest.DONE )
					{
						complete( xhr.responseText );
					}
				}
				var xhrdata = "json=" + encodeURIComponent( JSON.stringify( data ) );
				xhr.open( "POST", url );
				xhr.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" );
				xhr.send( xhrdata );
			}

			function sync()
			{
				if ( navigator.onLine )
				{
					var lastServerData = currentData.get();
					
					var diff = get_new_changes(
						lastServerData,
						getItemsFromPage()
					);
					
					if ( !isEmpty( diff ) )
					{
						diff = { "items" : diff };
					}
					
					var lastModified = getLastModified( lastServerData );
					if ( lastModified )
					{
						diff[ "lastModified" ] = lastModified;
					}
					
					post(
						"sync.php",
						diff,
						function( d )
						{
							updatePageJson( d );
							lastSynced = new Date();
						}
					);
				}
			}
			
			function addRow( str )
			{
				if ( str.length )
				{
					var row = get_or_create_item( str );
					row.classList.remove( "hidden" );
					row.classList.remove( "strike" );
				}
			}
			
			function removeItem( str )
			{
				findItem( str ).classList.add( "hidden" );
			}
			
			var input = ONE("input[name=item]");
			
			function syncIfNeeded()
			{
				// wait a bit in case the press that caused this update also
				// triggered a real sync
				clearTimeout( syncIfNeeded.timer );
				syncIfNeeded.timer = setTimeout(
					function()
					{
						var now = new Date();
						if ( now.getTime() - lastSynced.getTime() > 5000 )
						{
							sync();
						}
					},
					100
				)
			}
			
			var preventToggle = false;
			
			function toggleRow( e )
			{
				if ( preventToggle ) return;
				var row = getRow( e.target ).classList;
				row.toggle( "strike" );
				row.add( "unsaved" );
				sortList();
				sync();
				e.preventDefault();
			}
			
			var refocus = false;
			
			on( document,
				"onmouseup",
				".item",
				function( e )
				{
					if ( refocus )
					{
						input.focus();
					}
					toggleRow( e );
				}
			);
			
			document.ontouchend = document.onmouseup;
			
			document.ontouchmove = function()
			{
				preventToggle = true;
			}
			document.ontouchstart = function( e )
			{
				refocus = document.activeElement == input;
				input.blur();
				preventToggle = false;
				syncIfNeeded();
				
			}
			
			document.onkeyup = function( e )
			{
				if ( e.keyCode == 13 )
				{
					addRow( input.value.trim() );
					sync();
					input.value = "";
				}
			}
			
			function findMatching( str )
			{
				var result = [];
				for ( var i in getItemsFromPage() )
				{
					if ( i.length > str.length && i.lastIndexOf( str, str.length ) === 0 )
					{
						result.push( i );
					}
				}
				return result;
			}
			
			function byLength( a, b )
			{
				return a.length > b.length;
			}
			
			function sameSize( len )
			{
				return function( a ) { return a.length === len; };
			}
			
			function suggest( str )
			{
				var i = input;
				var start = i.value.length;
				i.value = str;
				i.setSelectionRange( start, str.length );
				i.focus();
			}
			
			var nosuggest = false;
			
			
			input.onkeydown = function( e )
			{
				switch ( e.keyCode )
				{
					case 8: // backspace
					case 46: // delete
						nosuggest = true;
						break;
					default:
						nosuggest = false;
				}
			}
			
			input.oninput = function( e )
			{
				this.value = this.value.toLowerCase();
				if ( nosuggest ) return;
				var str = this.value;
				if ( !str.length ) return;
				var matches = findMatching( str ).sort( byLength );
				if ( !matches.length ) return;
				matches = matches.filter( sameSize( matches[ 0 ].length ) );
				if ( matches.length === 1 )
				{
					suggest( matches[ 0 ] );
				}
			}
			
			input.ontouchstart = function( e )
			{
				if ( document.activeElement == this )
				{
					this.blur();
					e.preventDefault();
				}
				syncIfNeeded();
			}
			
			input.onmousedown = input.ontouchstart;
			
			document.onvisibilitychange = syncIfNeeded;
			
			fillPage( currentData.get() );
			
			sync();
		}
		</script>
	</head>
	<body class="customfont noselect">
		<input class="customfont" name="item" type="text" />
		<div id="items">
			<div id="scrollbox">
			</div>
		</div>
	</body>
</html>
