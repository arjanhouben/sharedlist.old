<html manifest="cache.manifest">
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no" />
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<link rel="apple-touch-icon" href="icon.png">
		<link rel="apple-touch-icon-precomposed" href="icon-precomposed.png">
		<style>
		html, body
		{
			background-color: #789;
			overflow: hidden;
			height: 100%;
			width: 100%;
			margin: 0;
			border: 5px #789 solid;
			position: absolute;
			box-sizing: border-box;
		}
		.customfont
		{
			font-size: 18pt;
			font-family: sans-serif;
		}
		input[type=text]
		{
			background-color: transparent;
			border-color: black;
			border-width: 0 0 1px 0;
			width: 100%;
		}
		.strike > span
		{
			text-decoration: line-through;
			color: #555;
			width: 65%;
			overflow: hidden;
		}
		.noselect
		{
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		.hidden
		{
			display: none;
		}
		#scrollbox
		{
			height: 100%;
			overflow: auto;
			position: relative;
		}
		#items
		{
			height: 100%;
		}
		.item
		{
			position: relative;
			width: 100%;
			overflow: hidden;
		}
		.item > span
		{
			display: inline-block;
		}
		.item > .remove
		{
			display: none;
		}
		.item.strike > .remove
		{
			position: absolute;
			width: 30%;
			right: 0;
			display: inline-block;
		}
		.unsaved
		{
			font-style: italic;
		}
		</style>
		<script type="text/javascript" src="jquery-1.9.1.min.js"></script>
		<script type="text/javascript">
		function for_key_value( obj, f )
		{
			for ( var k in obj )
			{
				if ( obj.hasOwnProperty( k ) )
				{
					f( k, obj[ k ] );
				}
			}
		}
		function getLastModified( items )
		{
			var m = 0;
			for_key_value( items,
				function( k, v )
				{
					if ( v.modified > m )
					{
						m = v.modified;
					}
				}
			);
			return m;
		}
		function LocalData()
		{
			this.get = function()
			{
				if ( !localStorage[ "boodschappen" ] )
				{
					localStorage[ "boodschappen" ] = "{}";
				}
				return JSON.parse( localStorage[ "boodschappen" ] );
			}
			
			this.set = function( data )
			{
				localStorage[ "boodschappen" ] = JSON.stringify( data );
			}
		}
		function parseQuery( query )
		{
			var result = {};
			query
				.substr( query.indexOf( '?' ) + 1 )
				.split( '&' )
				.forEach(
					( i ) =>
					{
						var kv = i.split( '=' );
						result[ kv[ 0 ] ] = kv[ 1 ];
					}
				)
			return result;
		}
		$().ready(
			function()
			{
				"use strict";
		
				const query = parseQuery( location.search );
				var lastSynced = new Date();
				var currentData = new LocalData();
				var container = $( "#scrollbox" );
				var emptyrow = $( "<div class=\"item\"><span></span><input class=\"remove\" type=\"button\" value=\"weghalen\" /></div>" );
				
				if ( query.hasOwnProperty( "reset" ) )
				{
					currentData.set( {} );
				}
				
				function getRow( item )
				{
					return item.parents( "div.item" );
				}
				
				function findItem( str )
				{
					var result = null;
					container.children( "div.item" ).each(
						function( i, t )
						{
							if ( $(t).children("span").text() === str )
							{
								result = t;
								return false;
							}
						}
					);
					return $(result);
				}
				
				function get_or_create_item( str )
				{
					var row = findItem( str );
					if ( !row.length )
					{
						row = emptyrow.clone();
						var span = row.children( "span" );
						var remove_items = row.children( ".remove" );
						function remove()
						{
							$(this).parent( "div.item" ).addClass( "hidden" );
							sync();
						}
						remove_items.on(
							"mouseup touchend touchstart",
							remove
						);
						span.text( str );
					}
					container.prepend( row );
					return row;
				}
				
				function updatePageJson( data )
				{
					return updatePage( JSON.parse( data ) );
				}
				
				function sortItems( a, b )
				{
					var at = $(a).find( "span" ).text();
					var bt = $(b).find( "span" ).text();
					if ( at < bt ) return -1;
					if ( at > bt ) return 1;
					return 0;
				}
				
				function sortList()
				{
					var items = container.children( "div.item" );
					var active = items.not( ".hidden" );
					var strike = active.filter( ".strike" );
					var normal = active.not( ".strike" );
					normal.sort( sortItems );
					strike.sort( sortItems );
					container.append( normal );
					container.append( strike );
				}
				
				function isEmpty( obj )
				{
					return Object.keys( obj ).length === 0;
				}
				
				function fillPage( data )
				{
					for ( var name in data )
					{
						var i = get_or_create_item( name );
						i.data( "modified", data[ name ][ "modified" ] );
						i.removeClass( "hidden" );
						i.removeClass( "strike" );
						i.addClass( data[ name ][ "state" ] );
					}
					
					sortList()
				}
				
				function updatePage( data )
				{
					var complete = currentData.get();
					var diff = get_new_changes( complete, data[ "items" ] );

					for_key_value(
						data[ "items" ],
						( k, v ) => { complete[ k ] = v; }
					);

					currentData.set( complete );
										
					if ( !isEmpty( data.errors ) )
					{
						console.log( data.errors );
						fillPage( complete );
					}
					else
					{
						fillPage( diff );
					}

					
					$(".unsaved").removeClass( "unsaved" );
				}
				
				function getItemsFromPage()
				{
					var items = {};
					container.children( "div.item" ).each(
						function( i, t )
						{
							var row = $(t);
							var str = row.children("span").text();
							if ( str.length )
							{
								items[ str ] = {
									"modified": row.data( "modified" ) || 0,
									"state": row.hasClass( "hidden" ) ? "hidden" : ( row.hasClass( "strike" ) ? "strike" : "active" )
								};
							}
						}
					);
					return items;
				}
				
				function itemDifferent( a, b )
				{
					return ( a[ "state" ] !== b[ "state" ] );
				}
			
				function get_new_changes( old_value, new_value )
				{
					var result = {};
					if ( !old_value )
					{
						return new_value;
					}
					for_key_value( new_value,
						function( k, v )
						{
							if ( old_value.hasOwnProperty( k ) )
							{
								if ( itemDifferent( old_value[ k ], v ) )
								{
									result[ k ] = v;
								}
							}
							else
							{
								result[ k ] = v;
							}
						}
					)
					return result;
				}

				function sync()
				{
					if ( navigator.onLine )
					{
						var lastServerData = currentData.get();
						
						var diff = get_new_changes(
							lastServerData,
							getItemsFromPage()
						);
						
						if ( !isEmpty( diff ) )
						{
							diff = { "items" : diff };
						}
						
						var lastModified = getLastModified( lastServerData );
						if ( lastModified )
						{
							diff[ "lastModified" ] = lastModified;
						}
						
						$.post(
							"sync.php",
							diff,
							function( d )
							{
								updatePageJson( d );
								lastSynced = new Date();
							}
						);
					}
				}
				
				function addRow( str )
				{
					if ( str.length )
					{
						var row = get_or_create_item( str );
						row.removeClass( "hidden" );
						row.removeClass( "strike" );
					}
				}
				
				function removeItem( str )
				{
					var row = getRow( findItem( str ) );
					if ( !row.length || row.hasClass( "hidden" ) )
					{
						return;
					}
					row.addClass( "hidden" );
				}
				
				var input = $("input[name=item]");
				
				function syncIfNeeded()
				{
					// wait a bit in case the press that caused this update also
					// triggered a real sync
					clearTimeout( syncIfNeeded.timer );
					syncIfNeeded.timer = setTimeout(
						function()
						{
							var now = new Date();
							if ( now.getTime() - lastSynced.getTime() > 5000 )
							{
								sync();
							}
						},
						100
					)
				}
				
				var preventToggle = false;
				
				function toggleRow( e )
				{
					if ( preventToggle ) return;
					var row = getRow( $(e.target) );
					row.toggleClass( "strike" ).addClass( "unsaved" );
					var isStrike = row.hasClass( "strike" );
					sync();
					e.preventDefault();
				}
				
				var refocus = false;
				
				$(document)
				.on
				(
					"touchend",
					".item",
					function( e )
					{
						if ( refocus )
						{
							input.focus();
						}
						toggleRow( e );
					}
					
				).on
				(
					"touchmove",
					function()
					{
						preventToggle = true;
					}
				).on
				(
					"touchstart",
					function()
					{
						refocus = document.activeElement == input[ 0 ];
						input.blur();
						preventToggle = false;
						syncIfNeeded();
					}
				)
				.on
				(
					"mouseup",
					".item>span",
					toggleRow
				)
				.on
				(
					"keyup",
					function( e )
					{
						if ( e.keyCode == 13 )
						{
							addRow( input.val().trim() );
							sync();
							input.val( "" );
						}
					}
				);
				
				function findMatching( str )
				{
					var result = [];
					for ( var i in getItemsFromPage() )
					{
						if ( i.length > str.length && i.lastIndexOf( str, str.length ) === 0 )
						{
							result.push( i );
						}
					}
					return result;
				}
				
				function byLength( a, b )
				{
					return a.length > b.length;
				}
				
				function sameSize( len )
				{
					return function( a ) { return a.length === len; };
				}
				
				function suggest( str )
				{
					var i = input[ 0 ];
					var start = i.value.length;
					i.value = str;
					i.setSelectionRange( start, str.length );
					i.focus();
				}
				
				var nosuggest = false;
				
				input.on(
					"keydown",
					function( e )
					{
						switch ( e.keyCode )
						{
							case 8: // backspace
							case 46: // delete
								nosuggest = true;
								break;
							default:
								nosuggest = false;
						}
					}
				)
				
				input.on
				(
					"input",
					function( e )
					{
						this.value = this.value.toLowerCase();
						if ( nosuggest ) return;
						var str = this.value;
						if ( !str.length ) return;
						var matches = findMatching( str ).sort( byLength );
						if ( !matches.length ) return;
						matches = matches.filter( sameSize( matches[ 0 ].length ) );
						if ( matches.length === 1 )
						{
							suggest( matches[ 0 ] );
						}
					}
				).on
				(
					"touchstart mousedown",
					function( e )
					{
						if ( document.activeElement == this )
						{
							this.blur();
							e.preventDefault();
						}
						syncIfNeeded();
					}
				);
				
				$(document).on(
					"visibilitychange",
					syncIfNeeded
				)
				
				fillPage( currentData.get() );
				
				sync();
			}
		);
		</script>
	</head>
	<body class="customfont noselect">
		<div>
			<input name="item" type="text" />
		</div>
		<div id="items">
			<div id="scrollbox">
			</div>
		</div>
	</body>
</html>
